# Sticky Notes Backend

Это небольшой бэкэнд‑прототип модуля «Стикеры» для платформы совместной работы. Он написан на TypeScript и демонстрирует работу с **Express**, **Sequelize**, **PostgreSQL**, WebSocket‑уведомлениями и простейшей аутентификацией на основе JWT. Код структурирован по слоям (модели, сервисы, контроллеры) и снабжён unit‑тестами.

## Быстрый старт

1. **Клонировать репозиторий** и перейти в каталог проекта:

   ```bash
   git clone <repo-url> sticky-notes-app
   cd sticky-notes-app
   ```

2. **Установить зависимости**. Проект использует `npm` и ESM‑модули:

   ```bash
   npm install
   ```

3. **Подготовить базу данных**. Приложение ожидает запущенный PostgreSQL. Создайте пустую базу `sticky` и пользователя. Пример через `psql`:

   ```sql
   CREATE DATABASE sticky;
   CREATE USER sticky_user WITH ENCRYPTED PASSWORD 'secret';
   GRANT ALL PRIVILEGES ON DATABASE sticky TO sticky_user;
   ```

   Либо поднимите готовый сервер через Docker:

   ```bash
   docker run -d -p 5432:5432 \
     -e POSTGRES_DB=sticky \
     -e POSTGRES_USER=sticky_user \
     -e POSTGRES_PASSWORD=secret \
     postgres:15
   ```

4. **Настройте переменные окружения**. Создайте файл `.env` в корне со следующими параметрами:

   ```env
   DB_HOST=localhost
   DB_PORT=5432
   DB_NAME=sticky
   DB_USER=sticky_user
   DB_PASSWORD=secret
   JWT_SECRET=change-me
   PORT=3000
   ```

5. **Запустите сервер** в режиме разработки:

   ```bash
   npm run dev
   ```

   Скрипт запуска использует встроенный загрузчик `ts-node/esm`, поэтому вам не нужен `ts-node-dev`. Сервер поднимет HTTP API и WebSocket на указанном порту. По умолчанию это `http://localhost:3000`.

6. **Импортировать коллекцию запросов** из `insomnia.json` в Insomnia или Postman. Там есть примеры для регистрации, логина, создания стикеров, перемещения и работы с комментариями.

Для запуска тестов используйте:

```bash
npm test
```

> Обратите внимание: unit‑тесты используют SQLite в памяти, поэтому не затрагивают вашу основную базу.

## Структура каталогов

- `src/config` – инициализация базы данных (Sequelize).
- `src/models` – определения моделей `Note` и `Comment` с полями и ассоциациями.
- `src/services` – бизнес‑логика. Сервис заметок инкапсулирует CRUD и логику упорядочивания; сервис комментариев занимается CRUD для комментариев.
- `src/controllers` – Express‑контроллеры, принимающие HTTP‑запросы и делегирующие работу сервисам. Здесь же отправляются события в WebSocket.
- `src/routes` – сборка всех роутов в единый `api/v1`.
- `src/middlewares` – промежуточные слои, в том числе проверка JWT.
- `src/socket` – настройка Socket.IO и функции для эмиссии событий (`noteCreated`, `noteUpdated`, `commentCreated` и т.д.).
- `src/auth` – простейший сервис пользователей (in‑memory) для регистрации и логина. Хеширование паролей выполняется через bcrypt, если он установлен, либо через безопасный fallback на SHA‑256.
- `src/tests` – unit‑тесты для сервисов с использованием Vitest.
- `README.md` – этот файл.
- `insomnia.json` – коллекция примерных запросов.

## Архитектурные решения

- **Разделение на слои.** Контроллеры не содержат бизнес‑логики; они лишь принимают данные и отвечают на HTTP‑клиент. Вся работа с БД сосредоточена в сервисах, что упрощает тестирование.
- **Позиционирование стикеров.** Для хранения порядка использован числовой атрибут `order`. При перемещении вверх/вниз вычисляется новое значение как среднее между соседями. Если элемент перемещён в начало/конец, значение уменьшается/увеличивается. Такой подход позволяет не переставлять все строки в таблице и эффективно поддерживать произвольное количество элементов между двумя соседями.
- **WebSocket‑нотификации.** Изменения стикеров и комментариев тут же отправляются всем подключённым клиентам через Socket.IO. Сервис не содержит логики отображения, лишь транслирует изменения.
- **Аутентификация.** Использован JWT: пользователь логинится и получает токен, который затем отправляет в заголовке `Authorization: Bearer <token>`. Для примера реализовано in‑memory хранилище пользователей.
- **Типизация и аннотации.** Каждая функция снабжена JSDoc‑аннотациями с описанием параметров и возвращаемых значений. Очевидные места не изобилуют комментариями, но там, где может быть непонятно, пояснения даны.
- **Unit‑тесты.** Тестируются граничные сценарии: создание заметок, перемещение, удаление, операции с комментариями. Для тестов используется SQLite в памяти.

## Дополнительная функция: комментарии

В качестве необязательного, но полезного расширения реализована возможность добавлять **комментарии** к каждой заметке. Эта функциональность потребовала отдельную модель, ассоциацию `Note.hasMany(Comment)`, сервис, контроллер и поддержку real‑time событий. Зачем это нужно? В процессе мозгового штурма важно фиксировать уточнения и пояснения к идеям. Комментарии позволяют участникам дискуссии оставить короткие замечания, не раздувая основной текст стикера.

Комментарии наследуют общую схему: сохраняются в БД, доступны через REST‑API, появляются у всех клиентов сразу через WebSocket и удаляются вместе со стикером. В перспективе на базе этой инфраструктуры можно развить историю версий, вложенные обсуждения или реакции. Трудоёмкость реализации: ~3 часа (моделирование, связи, эндпоинты, тесты).

## Заключение

Данный прототип демонстрирует подход к структуре кода, использование TypeScript и аккуратное отделение бизнес‑логики от инфраструктуры. Он легко расширяем: можно добавлять новые типы объектов (например, изображения или файлы) и дополнительные функции (роли пользователей, экспорт досок, undo/redo) без ломания существующей архитектуры.